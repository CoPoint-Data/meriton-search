// Prisma Schema for Meriton Search
// Supports multi-tenant RBAC with OpCo isolation

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Operating Company (Tenant)
model OpCo {
  id          String   @id @default(cuid())
  name        String   @unique
  code        String   @unique // e.g., "opco_001"
  description String?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users User[]

  @@map("opcos")
}

// User Roles (Enum)
enum Role {
  ADMIN            // Full access across all OpCos
  FINANCE_MANAGER  // Financial data access within OpCo
  EMPLOYEE         // Operational data access within OpCo
  VENDOR_PORTAL    // Limited access to vendor-specific data
}

// User Model
model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  firstName    String   @map("first_name")
  lastName     String   @map("last_name")
  role         Role     @default(EMPLOYEE)
  active       Boolean  @default(true)

  // Multi-tenant association
  opCoId       String?  @map("opco_id")
  opCo         OpCo?    @relation(fields: [opCoId], references: [id])

  // Vendor association (optional, for vendor portal users)
  vendorId     String?  @map("vendor_id")

  // Audit fields
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  lastLoginAt  DateTime? @map("last_login_at")

  @@index([email])
  @@index([opCoId])
  @@index([role])
  @@map("users")
}

// Session Model (simple token-based auth)
model Session {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now())

  @@index([token])
  @@index([userId])
  @@map("sessions")
}
